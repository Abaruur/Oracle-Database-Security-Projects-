-- IA 643 Database Security and Auditing
-- Script file for Project 5 Virtual Private Database
-- Fall 2023
-- Dr. Jim Q. Chen

Drop table DAILY_WORK_HOURS;
Drop Table TIMESHEET;
Drop Table COMPANY_ADMINISTRATORS;
Drop Table EMPLOYEE;
Drop Table COMPANY;
Drop Table PAYROLL_PERIOD;

CREATE TABLE PAYROLL_PERIOD (
       PP_ID                NUMBER CONSTRAINT Payroll_Period_PK PRIMARY KEY,
       PP_DESCRIPTION       VARCHAR2(255) NOT NULL,
       CTL_SEC_USER         VARCHAR2(30) NULL,
       CTL_SEC_LEVEL        NUMBER NULL
);

INSERT INTO PAYROLL_PERIOD VALUES(
200, 'Bi-weekly', 'JADMIN', 4);
INSERT INTO PAYROLL_PERIOD VALUES(
400, 'Monthly', 'FADMIN', 4);


CREATE TABLE COMPANY (
       COMPANY_ID           NUMBER CONSTRAINT Company_Pk PRIMARY KEY,
       PP_ID                NUMBER NULL,
       CONTACT_NAME         VARCHAR2(30) NOT NULL,
       STREET_ADDRESS       VARCHAR2(50) NOT NULL,
       CITY                 VARCHAR2(30) NOT NULL,
       STATE                VARCHAR2(2) NOT NULL,
       ZIPCODE              VARCHAR2(9) NOT NULL,
       PHONE                VARCHAR2(15) NOT NULL,
       FAX                  VARCHAR2(15) NOT NULL,
       EMAIL                VARCHAR2(50) NOT NULL,
       URL                  VARCHAR2(50) NOT NULL,
       STATUS               VARCHAR2(10) NOT NULL,
       CTL_SEC_USER         VARCHAR2(30) NULL,
       CTL_SEC_LEVEL        NUMBER NULL,
       CONSTRAINT Company_PPID_FK FOREIGN KEY (PP_ID)
                             REFERENCES PAYROLL_PERIOD
);


INSERT INTO COMPANY VALUES(
0090, 200, 'Nexum', '780 South 4th Ave.', 'St. Paul','MN', '55331','6123084992', 
'6123087896','HR@Nexum.com', 'www.Nexum.com','A','JADMIN', 3);

INSERT INTO COMPANY VALUES(
0091, 400, 'Rashima', '278 W. St. Germain', 'St. Cloud','MN', '56301','3203184992', 
'3203187896','Rashima@Yahoo.com', 'www.RashimaCloth.com','A','FADMIN', 3);

CREATE TABLE EMPLOYEE (
       EMPLOYEE_ID          NUMBER CONSTRAINT Employee_PK PRIMARY KEY,
       COMPANY_ID           NUMBER CONSTRAINT Employee_Com_ID_FK REFERENCES COMPANY (COMPANY_ID),
       TAX_ID               NUMBER NOT NULL,
       FIRST_NAME           VARCHAR2(20) NOT NULL,
       LAST_NAME            VARCHAR2(20) NOT NULL,
       HOURLY_SALARY        NUMBER NOT NULL,
       FED_CODE             NUMBER NOT NULL,
       STATE_CODE           NUMBER NOT NULL,
       MEDICAL_ELECTION     NUMBER NOT NULL,
       FOUR01_ELECTION      NUMBER NOT NULL,
       MEDICAL_DEDUCTION    NUMBER NOT NULL,
       OTHER_DEDUCTION      NUMBER NOT NULL,
       SICK_DAYS            NUMBER NOT NULL,
       VACATION_DAYS        NUMBER NOT NULL,
       CTL_SEC_USER         VARCHAR2(30) NULL,
       CTL_SEC_LEVEL        NUMBER NULL
);

INSERT INTO EMPLOYEE VALUES(
1001, 0090, '10201','John','Hansen', 12.5, 707, 505,4,401,20,10, 3, 12, 'JADMIN', 4);

INSERT INTO EMPLOYEE VALUES(
1002, 0091, '10201','Stephanie','Smith', 12.5, 707, 505,4,401,20,10, 3, 12, 'FADMIN', 4);


CREATE TABLE COMPANY_ADMINISTRATORS (
       CA_ID                NUMBER CONSTRAINT CA_PK PRIMARY KEY,
       COMPANY_ID           NUMBER NULL,
       FIRST_NAME           VARCHAR2(20) NOT NULL,
       LAST_NAME            VARCHAR2(20) NOT NULL,
       SYSTEM_USERNAME      VARCHAR2(30) NOT NULL,
       CTL_SEC_USER         VARCHAR2(20) NULL,
       CTL_SEC_LEVEL        NUMBER NULL
);
INSERT INTO COMPANY_ADMINISTRATORS VALUES(
20, 0090, 'Joe','Harris','Jadmin', 'DBA643', 5);
INSERT INTO COMPANY_ADMINISTRATORS VALUES(
21, 0091, 'Felisa','Davis','Fadmin', 'DBA643', 5);


CREATE TABLE TIMESHEET (
       TS_ID                NUMBER CONSTRAINT TimeSheet_Pk PRIMARY KEY,
       EMPLOYEE_ID          NUMBER CONSTRAINT Timesheet_FK REFERENCES EMPLOYEE,
       START_DATE           DATE NOT NULL,
       END_DATE             DATE NOT NULL,
       WORK_HOURS           NUMBER NOT NULL,
       SICK_HOURS           NUMBER NOT NULL,
       CTL_SEC_USER         VARCHAR2(30) NULL,
       CTL_SEC_LEVEL        NUMBER NULL
);

INSERT INTO TIMESHEET VALUES(
11, 1001, '1-Jul-09', '15-Jul-09', 72, 8, 'JADMIN', 4);
INSERT INTO TIMESHEET VALUES(
22, 1002, '1-Jul-09', '29-Jul-09', 160, 0, 'FADMIN', 4);


CREATE TABLE DAILY_WORK_HOURS (
       DWH_ID               NUMBER CONSTRAINT DailyHour_PK PRIMARY KEY,
       TS_ID                NUMBER CONSTRAINT DAILYHOURS_FK REFERENCES TIMESHEET,
       WORK_DAY             NUMBER NOT NULL,
       WORK_HOURS           NUMBER NOT NULL,
       SICK_HOURS           NUMBER NULL,
       CTL_SEC_USER         VARCHAR2(30) NULL,
       CTL_SEC_LEVEL        NUMBER NULL
);

INSERT INTO DAILY_WORK_HOURS VALUES(
80,11, 1,8,0,'JADMIN', 4);
INSERT INTO DAILY_WORK_HOURS VALUES(
81,11, 2,8,0,'JADMIN', 4);

INSERT INTO DAILY_WORK_HOURS VALUES(
82,22, 1,8,0,'FADMIN', 4);
INSERT INTO DAILY_WORK_HOURS VALUES(
83,22, 1,8,0,'FADMIN', 4);






-- Connect to DBA643 account
CONN IA643_DBA643/GOPI1234@ec2-52-91-153-81.compute-1.amazonaws.com/IA643;

-- Drop and create tablespace
DROP TABLESPACE IA643F21_TBS INCLUDING CONTENTS AND DATAFILES;
CREATE TABLESPACE IA643F21_TBS DATAFILE 'IA643F21.dat' size 500K AUTOEXTEND ON NEXT 300K MAXSIZE 50M;

-- Create JAdmin and FAdmin user accounts
DROP USER JAdmin CASCADE;
CREATE USER JAdmin IDENTIFIED BY JAdmin DEFAULT TABLESPACE IA643F21_TBS QUOTA 200K ON IA643F21_TBS TEMPORARY TABLESPACE TEMP ACCOUNT UNLOCK;
GRANT CONNECT, RESOURCE TO JAdmin;

DROP USER FAdmin CASCADE;
CREATE USER FAdmin IDENTIFIED BY FAdmin DEFAULT TABLESPACE IA643F21_TBS QUOTA 200K ON IA643F21_TBS TEMPORARY TABLESPACE TEMP ACCOUNT UNLOCK;
GRANT CONNECT, RESOURCE TO FAdmin;

-- Create Public Synonyms and Grant Privileges
DROP PUBLIC SYNONYM COMPANY;
CREATE PUBLIC SYNONYM COMPANY FOR IA643_DBA643.COMPANY;
GRANT SELECT, INSERT, UPDATE, DELETE ON COMPANY to JAdmin, FAdmin;

DROP PUBLIC SYNONYM EMPLOYEE;
CREATE PUBLIC SYNONYM EMPLOYEE FOR IA643_DBA643.EMPLOYEE;
GRANT SELECT, INSERT, UPDATE, DELETE ON EMPLOYEE to JAdmin, FAdmin;

DROP PUBLIC SYNONYM TIMESHEET;
CREATE PUBLIC SYNONYM TIMESHEET FOR IA643_DBA643.TIMESHEET;
GRANT SELECT, INSERT, UPDATE, DELETE ON TIMESHEET to JAdmin, FAdmin;

DROP PUBLIC SYNONYM PAYROLL_PERIOD;
CREATE PUBLIC SYNONYM PAYROLL_PERIOD FOR IA643_DBA643.PAYROLL_PERIOD;
GRANT SELECT, INSERT, UPDATE, DELETE ON PAYROLL_PERIOD to JAdmin, FAdmin;

DROP PUBLIC SYNONYM DAILY_WORK_HOURS;
CREATE PUBLIC SYNONYM DAILY_WORK_HOURS FOR IA643_DBA643.DAILY_WORK_HOURS;
GRANT SELECT, INSERT, UPDATE, DELETE ON DAILY_WORK_HOURS to JAdmin, FAdmin;

-- Create Triggers for Record Ownership
CREATE OR REPLACE TRIGGER COMPANY_v BEFORE INSERT OR UPDATE ON COMPANY FOR EACH ROW BEGIN :NEW.CTL_SEC_USER := USER; END;
/
CREATE OR REPLACE TRIGGER EMPLOYEE_v BEFORE INSERT OR UPDATE ON EMPLOYEE FOR EACH ROW BEGIN :NEW.CTL_SEC_USER := USER; END;
/
CREATE OR REPLACE TRIGGER TIMESHEET_v BEFORE INSERT OR UPDATE ON TIMESHEET FOR EACH ROW BEGIN :NEW.CTL_SEC_USER := USER; END;
/
CREATE OR REPLACE TRIGGER PAYROLL_PERIOD_v BEFORE INSERT OR UPDATE ON PAYROLL_PERIOD FOR EACH ROW BEGIN :NEW.CTL_SEC_USER := USER; END;
/
CREATE OR REPLACE TRIGGER DAILY_WORK_HOURS_v BEFORE INSERT OR UPDATE ON DAILY_WORK_HOURS FOR EACH ROW BEGIN :NEW.CTL_SEC_USER := USER; END;
/

--Create policy function
CREATE OR REPLACE FUNCTION Sec_Fun_Cust (P_schema_name IN VARCHAR2, P_object_name IN VARCHAR2) Return VARCHAR2 IS
  V_where VARCHAR2(300);
BEGIN
  If User = 'IA643_DBA643' then
    V_where := '';
  Else
  V_where := 'CTL_SEC_USER = USER';
  END IF;
  RETURN V_Where;
END;
/



-- Add policy function

exec DBMS_RLS.ADD_Policy ('IA643_DBA643','COMPANY','Row_Owner_Sec','IA643_DBA643','Sec_Fun_Cust','SELECT, INSERT, UPDATE, DELETE',TRUE);

exec DBMS_RLS.ADD_Policy ('IA643_DBA643','EMPLOYEE','Row_Owner_Sec','IA643_DBA643','Sec_Fun_Cust','SELECT, INSERT, UPDATE, DELETE',TRUE);

exec DBMS_RLS.ADD_Policy ('IA643_DBA643','TIMESHEET','Row_Owner_Sec','IA643_DBA643','Sec_Fun_Cust','SELECT, INSERT, UPDATE, DELETE',TRUE);

exec DBMS_RLS.ADD_Policy ('IA643_DBA643','PAYROLL_PERIOD','Row_Owner_Sec','IA643_DBA643','Sec_Fun_Cust','SELECT, INSERT, UPDATE, DELETE',TRUE);

exec DBMS_RLS.ADD_Policy ('IA643_DBA643','DAILY_WORK_HOURS','Row_Owner_Sec','IA643_DBA643','Sec_Fun_Cust','SELECT, INSERT, UPDATE, DELETE',TRUE);





---drop policy----------

EXEC DBMS_RLS.DROP_POLICY('IA643_DBA643', 'COMPANY', 'Row_Owner_Sec');

EXEC DBMS_RLS.DROP_POLICY('IA643_DBA643', 'EMPLOYEE', 'Row_Owner_Sec');

EXEC DBMS_RLS.DROP_POLICY('IA643_DBA643', 'TIMESHEET', 'Row_Owner_Sec');

EXEC DBMS_RLS.DROP_POLICY('IA643_DBA643', 'PAYROLL_PERIOD', 'Row_Owner_Sec');

EXEC DBMS_RLS.DROP_POLICY('IA643_DBA643', 'DAILY_WORK_HOURS', 'Row_Owner_Sec');